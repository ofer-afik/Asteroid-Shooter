name: Build executables

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [macos-13, ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # Python setup
      # -------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------------------------------
      # OS dependencies
      # -------------------------------------------------
      - if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libncurses6 libncursesw6 libtinfo6 xterm libfuse2

      - if: runner.os == 'Windows'
        run: python -m pip install windows-curses

      # -------------------------------------------------
      # Python tooling
      # -------------------------------------------------
      - run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      # -------------------------------------------------
      # Build game binary
      # -------------------------------------------------
      - name: Build game binary
        run: |
          pyinstaller \
            --onefile \
            --target-architecture universal2 \
            --name game \
            --hidden-import=curses \
            --hidden-import=_curses \
            code/game.py

      # =================================================
      # macOS: create clickable .app + proper zip
      # =================================================
      - if: runner.os == 'macOS'
        name: Build macOS app
        run: |
          APP=ASTEROID-SHOOTER.app
          mkdir -p "$APP/Contents/MacOS"

          cp dist/game "$APP/Contents/MacOS/game"

          # Launcher (opens Terminal and keeps it open)
          cat > "$APP/Contents/MacOS/launcher" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec open -a Terminal bash -c '"$DIR/game"; exec bash'
          EOF

          chmod +x "$APP/Contents/MacOS/"*

          # Info.plist
          cat > "$APP/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
           "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>launcher</string>
            <key>CFBundleIdentifier</key>
            <string>com.example.asteroidshooter</string>
            <key>CFBundleName</key>
            <string>ASTEROID-SHOOTER</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
          </dict>
          </plist>
          EOF

          # Proper macOS zip (preserves permissions & metadata)
          ditto -c -k --keepParent "$APP" ASTEROID-SHOOTER-macOS.zip

      # =================================================
      # Windows build
      # =================================================
      - if: runner.os == 'Windows'
        name: Build Windows launcher
        shell: pwsh
        run: |
          @"
          import subprocess, sys, os
          base = getattr(sys, "_MEIPASS", os.path.dirname(sys.executable))
          game = os.path.join(base, "game.exe")
          subprocess.Popen(["cmd", "/k", game])
          "@ | Out-File launcher.py -Encoding utf8

          pyinstaller --onefile --name ASTEROID-SHOOTER --add-binary "dist/game.exe;." launcher.py

      # =================================================
      # Linux: AppImage
      # =================================================
      - if: runner.os == 'Linux'
        name: Build Linux AppImage
        run: |
          mkdir -p AppDir/usr/bin
          cp dist/game AppDir/usr/bin/game

          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "$0")")"

          for term in x-terminal-emulator gnome-terminal konsole xterm; do
            if command -v "$term" >/dev/null 2>&1; then
              exec "$term" -e "$HERE/usr/bin/game"
            fi
          done

          echo "No supported terminal found."
          exit 1
          EOF

          chmod +x AppDir/AppRun

          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          ./appimagetool-x86_64.AppImage ./AppDir ASTEROID-SHOOTER.AppImage

      # -------------------------------------------------
      # Upload artifacts
      # -------------------------------------------------
      - if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ASTEROID-SHOOTER-macOS
          path: ASTEROID-SHOOTER-macOS.zip

      - if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ASTEROID-SHOOTER-Windows
          path: dist/ASTEROID-SHOOTER.exe

      - if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: ASTEROID-SHOOTER-Linux
          path: ASTEROID-SHOOTER.AppImage
